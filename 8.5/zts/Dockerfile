# syntax=ghcr.io/khs1994-docker/docker.io/docker/dockerfile-upstream:master-labs
ARG PHP_VERSION=8.5.0

ARG REGISTRY_PREFIX=ghcr.io/khs1994-docker/docker.io

FROM --platform=$TARGETPLATFORM ${REGISTRY_PREFIX}/library/php:${PHP_VERSION}-alpine AS upstream

FROM --platform=$TARGETPLATFORM ghcr.io/khs1994-docker/docker.io/library/golang:1.24-alpine AS go

FROM --platform=$TARGETPLATFORM ghcr.io/khs1994-docker/docker.io/library/alpine:3.22

LABEL maintainer="khs1994-docker/lnmp <khs1994@khs1994.com>"

ENV TZ=Asia/Shanghai \
    APP_ENV=development

ARG PHP_VERSION=8.5.0

ARG ALPINE_URL=dl-cdn.alpinelinux.org

ARG PHP_EXTENSION_EXTRA

ARG PECL_EXTENSION_EXTRA

ARG APK_EXTRA

ARG APK_DEV_EXTRA

ARG PHP_EXTRA_CONFIGURE_ARGS_NEW

# dependencies required for running "phpize"
# these get automatically installed and removed by "docker-php-ext-*" (unless they're already installed)
ENV PHPIZE_DEPS \
      autoconf \
      dpkg-dev dpkg \
      file \
      g++ \
      gcc \
      libc-dev \
      make \
      pkgconf \
      re2c \
      bison

# persistent / runtime deps
RUN set -ex \
      && sed -i "s/dl-cdn.alpinelinux.org/${ALPINE_URL}/g" /etc/apk/repositories \
      && apk add --no-cache \
                 ca-certificates \
                 curl \
                 tar \
                 xz \
# https://github.com/docker-library/php/issues/494
                 openssl \
                 bash \
                 tzdata \
                 less \
# ensure www-data user exists
# RUN set -x \
      && adduser -u 82 -D -S -G www-data www-data
# 82 is the standard uid/gid for "www-data" in Alpine
# http://git.alpinelinux.org/cgit/aports/tree/main/apache2/apache2.pre-install?h=v3.3.2
# http://git.alpinelinux.org/cgit/aports/tree/main/lighttpd/lighttpd.pre-install?h=v3.3.2
# http://git.alpinelinux.org/cgit/aports/tree/main/nginx-initscripts/nginx-initscripts.pre-install?h=v3.3.2

ENV PHP_INI_DIR /usr/local/etc/php
# RUN mkdir -p $PHP_INI_DIR/conf.d

##<autogenerated>##
ENV PHP_EXTRA_CONFIGURE_ARGS \
# https://github.com/docker-library/php/pull/1259
        # --enable-phpdbg \
        # --enable-phpdbg-readline \
        --disable-phpdbg \
        # --enable-fpm \
        # --with-fpm-user=www-data \
        # --with-fpm-group=www-data \
        # https://github.com/docker-library/php/issues/510
        --enable-zts \
        --disable-zend-signals \
        --disable-cgi \
        --enable-embed \
        --enable-zend-max-execution-timers \
        --with-gettext=shared \
        --enable-gd=shared \
            --with-freetype \
            --disable-gd-jis-conv \
            --with-jpeg \
            --with-webp \
            --with-xpm \
            --with-avif \
        --with-pdo-mysql=shared \
        --with-pdo-pgsql=shared \
        # --with-xsl=shared \
        --enable-bcmath=shared \
        --enable-pcntl=shared \
        --with-external-pcre \
        --enable-shmop=shared \
        # --enable-soap=shared \
        --enable-sockets=shared \
        --enable-sysvmsg=shared \
        --enable-sysvsem=shared \
        --enable-sysvshm=shared \
        --enable-calendar=shared \
        --enable-intl=shared \
        --enable-exif=shared \
        --with-bz2=shared \
        # --with-tidy=shared \
        --with-gmp=shared \
        --with-enchant=shared \
        --enable-fileinfo=shared \
        --with-ldap=shared \
            --with-ldap-sasl \
        --enable-shmop=shared \
        # --with-snmp=shared \
        --with-mysqli=shared \
        --with-pgsql=shared \
        --enable-ctype=shared \
        --enable-dom=shared \
        --enable-pdo=shared \
        --enable-phar=shared \
        --enable-posix=shared \
        --enable-session=shared \
        --enable-simplexml=shared \
        --enable-tokenizer=shared \
        --enable-xml=shared \
        --enable-xmlreader=shared \
        --enable-xmlwriter=shared \
        --with-ffi=shared \
        --with-zip=shared \
        ${PHP_EXTRA_CONFIGURE_ARGS_NEW:-}
##</autogenerated>##

# Apply stack smash protection to functions using local buffers and alloca()
# Make PHP's main executable position-independent (improves ASLR security mechanism, and has no performance impact on x86_64)
# Enable optimization (-O2)
# Enable linker optimization (this sorts the hash buckets to improve cache locality, and is non-default)
# Adds GNU HASH segments to generated executables (this is used if present, and is much faster than sysv hash; in this configuration, sysv hash is also generated)
# https://github.com/docker-library/php/issues/272
ENV PHP_CFLAGS="-fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64"
ENV PHP_CPPFLAGS="$PHP_CFLAGS"
ENV PHP_LDFLAGS="-Wl,-O1 -pie"

# ENV GPG_KEYS 1729F83938DA44E27BA0F4D3DBDB397470D12172 B1B44D8F021E4E2D6021E995DC9FF8D3EE5AF27F

ENV PHP_VERSION=${PHP_VERSION}
# ENV PHP_URL="https://www.php.net/get/php-7.4.22.tar.xz/from/this/mirror" PHP_ASC_URL="https://www.php.net/get/php-7.4.22.tar.xz.asc/from/this/mirror"
# ENV PHP_SHA256="da1a705c0bc46410e330fc6baa967666c8cd2985378fb9707c01a8e33b01d985" PHP_MD5=""

# COPY --from=php:alpine /usr/local/bin/docker-php-* /usr/local/bin/

# COPY --from=php:alpine /usr/local/bin/docker-php-source /usr/local/bin/
# COPY --from=php:alpine /usr/local/bin/docker-php-entrypoint /usr/local/bin/
# COPY --from=php:alpine /usr/local/bin/docker-php-ext-configure /usr/local/bin/
# COPY --from=php:alpine /usr/local/bin/docker-php-ext-enable /usr/local/bin/
# COPY --from=php:alpine /usr/local/bin/docker-php-ext-install /usr/local/bin/

RUN --mount=type=bind,from=upstream,source=/usr/src,target=/usr/local/src,rw \
    --mount=type=bind,from=upstream,source=/usr/local/bin,target=/opt/bin,rw \
  set -xe \
  && mkdir -p /usr/src \
  && cp /usr/local/src/* /usr/src/ \
  && export PATH=$PATH:/opt/bin \
  && mkdir -p $PHP_INI_DIR/conf.d \
  && cp /opt/bin/docker-php-entrypoint /usr/local/bin \
  && mkdir -p \
		/app/public \
		/config/caddy \
		/data/caddy \
		/etc/caddy \
		/etc/frankenphp \
	&& sed -i 's/php/frankenphp run/g' /usr/local/bin/docker-php-entrypoint \
	&& echo '<?php phpinfo();' > /app/public/index.php \
  && apk add --no-cache --virtual .build-deps \
          $PHPIZE_DEPS \
          argon2-dev \
          coreutils \
          curl-dev \
          gnu-libiconv-dev \
          libsodium-dev \
          libxml2-dev \
          linux-headers \
          oniguruma-dev \
          openssl-dev \
          patch \
		      patchutils \
          readline-dev \
          sqlite-dev \
          cyrus-sasl-dev \
          postgresql-dev \
          libzip-dev \
          zlib-dev \
          libpng-dev \
          freetype-dev \
          libjpeg-turbo-dev \
          libxpm-dev \
          libwebp-dev \
          libexif-dev \
          # libxslt-dev \
          gmp-dev \
          bzip2-dev \
          enchant2-dev \
          gettext-dev \
          icu-dev \
          krb5-dev \
          aspell-dev \
          openldap-dev \
          pcre2-dev \
          # tidyhtml-dev \
          # net-snmp-dev \
          openldap-dev \
          libavif-dev \
          ${APK_DEV_EXTRA:-} \
  \
  && rm -vf /usr/include/iconv.h \
  && export CFLAGS="$PHP_CFLAGS" \
            CPPFLAGS="$PHP_CPPFLAGS" \
            LDFLAGS="$PHP_LDFLAGS" \
            PHP_BUILD_PROVIDER='https://github.com/khs1994-docker/php' \
            PHP_UNAME='Linux - Docker' \
  && docker-php-source extract \
  && cd /usr/src/php \
  && gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)" \
  \
  # && apk add --no-cache patch \
  # && { \
  #       echo "--- a/build/php.m4"; \
  #    } | tee 1.diff \
  # && patch -p1 < 1.diff \
  # && apk del --no-network patch \
  # && rm -rf 1.diff \
  # && ./buildconf --force \
  \
  # https://github.com/php/php-src/issues/18743 "Incompatibility in Inline TLS Assembly on Alpine 3.22 with zend_jit_ir.c"
	# https://github.com/docker-library/php/pull/1580
	# curl -fL 'https://github.com/php/php-src/commit/4c7220322bc74b0fc8416e1958cadd7bc51fe1b7.diff?full_index=1' -o 18743.patch; \
	# echo 'a19e795b24c52d4d1aa3d45b67339e1b62a5365b37cf4418b83e2709fc98bcb5 *18743.patch' | sha256sum -c -; \
	# filterdiff -x '*/NEWS' 18743.patch | patch -p1; \
	# rm 18743.patch \
  \
  && ./configure \
    --build="$gnuArch" \
    --with-config-file-path="$PHP_INI_DIR" \
    --with-config-file-scan-dir="$PHP_INI_DIR/conf.d" \
    \
# make sure invalid --configure-flags are fatal errors instead of just warnings
    --enable-option-checking=fatal \
    \
# https://github.com/docker-library/php/issues/439
    --with-mhash \
    \
# https://github.com/docker-library/php/issues/822
    --with-pic \
    \
# --enable-ftp is included here because ftp_ssl_connect() needs ftp to be compiled statically (see https://github.com/docker-library/php/issues/236)
    --enable-ftp=shared \
# --enable-mbstring is included here because otherwise there's no way to get pecl to use it properly (see https://github.com/docker-library/php/issues/195)
    --enable-mbstring=shared \
# --enable-mysqlnd is included here because it's harder to compile after the fact than extensions are (since it's a plugin for several extensions, not an extension in itself)
    --enable-mysqlnd=shared \
# https://wiki.php.net/rfc/argon2_password_hash (7.2+)
    --with-password-argon2 \
# https://wiki.php.net/rfc/libsodium
    --with-sodium=shared \
# always build against system sqlite3 (https://github.com/php/php-src/commit/6083a387a81dbbd66d6316a3a12a63f06d5f7109)
    --with-pdo-sqlite=shared,/usr \
    --with-sqlite3=shared,/usr \
    \
    --with-curl=shared \
    --with-iconv=/usr \
    --with-openssl=shared \
      --with-system-ciphers \
    --with-readline \
    --with-zlib \
    \
# in PHP 7.4+, the pecl/pear installers are officially deprecated (requiring an explicit "--with-pear")
    # --with-pear \
    \
# bundled pcre does not support JIT on s390x
# https://manpages.debian.org/stretch/libpcre3-dev/pcrejit.3.en.html#AVAILABILITY_OF_JIT_SUPPORT
    $(test "$gnuArch" = 's390x-linux-musl' && echo '--without-pcre-jit') \
    \
    $PHP_EXTRA_CONFIGURE_ARGS \
  && make -j "$(nproc)" \
  && find -type f -name '*.a' -delete \
  && make install \
  && cp -v php.ini-* "$PHP_INI_DIR/" \
  && { find /usr/local/bin /usr/local/sbin -type f -perm +0111 -exec strip --strip-all '{}' + || true; } \
# && docker-php-source delete \
  \
  && docker-php-ext-enable bcmath \
                           bz2 \
                           calendar \
                           enchant \
                           # exif \
                           fileinfo \
                           # gd \
                           gettext \
                           gmp \
                           intl \
                           ldap \
                           pcntl \
                           openssl \
                           mysqlnd \
                           # mysqli \
                           pdo \
                           pdo_mysql \
                           pdo_pgsql \
                           pgsql \
                           shmop \
                           # snmp \
                           # soap \
                           sodium \
                           sockets \
                           sysvmsg \
                           sysvsem \
                           sysvshm \
                           # tidy \
                           # xsl \
                           # opcache 已经内置，无需再启用
                           ctype \
                           dom \
                           pdo_sqlite \
                           phar \
                           posix \
                           session \
                           simplexml \
                           sqlite3 \
                           tokenizer \
                           xml \
                           xmlreader \
                           xmlwriter \
                           ftp \
                           mbstring \
                           curl \
                           zip \
                           ffi \
                           ${PHP_EXTENSION_EXTRA:-} \
  && echo "extension=exif" > $PHP_INI_DIR/conf.d/docker-php-ext-z-exif.ini \
  && echo "extension=gd" > $PHP_INI_DIR/conf.d/docker-php-ext-z-gd.ini \
  && echo "extension=mysqli" > $PHP_INI_DIR/conf.d/docker-php-ext-z-mysqli.ini \
  && runDeps="$( \
    scanelf --needed --nobanner --format '%n#p' --recursive /usr/local \
      | tr ',' '\n' \
      | sort -u \
      | awk 'system("[ -e /usr/local/lib/" $1 " ]") == 0 { next } { print "so:" $1 }' \
  )" \
  && apk add --no-cache $runDeps \
  \
  # && strip --strip-all /usr/local/lib/libphp.so \
  && { find $(php-config --extension-dir) -type f -perm +0111 -exec strip --strip-all '{}' + || true; } \
  && apk del --no-network .build-deps \
  && rm -rf /usr/local/include/php/TSRM/tsrm_win32.h \
           /usr/local/include/php/TSRM/tsrm_config.w32.h \
           /usr/local/include/php/Zend/zend_config.w32.h \
           /usr/local/include/php/ext/mysqlnd/config-win.h \
           /usr/local/include/php/ext/standard/winver.h \
           /usr/local/php/man \
  \
# smoke test
  && php --version \
# sodium was built as a shared module (so that it can be replaced later if so desired), so let's enable it too (https://github.com/docker-library/php/issues/598)
# RUN docker-php-ext-enable sodium
  \
# 创建日志文件夹
  && ln -sf /dev/stderr /var/log/xdebug-remote.log \
  && rm -rf /usr/src/*

ENV PECL_BUILD_DEPS \
      libmemcached-dev \
      # yaml-dev \
      pcre2-dev \
      zlib-dev \
      zstd-dev \
# https://github.com/xdebug/xdebug/pull/835
      linux-headers

ENV PECL_RUN_DEPS \
      libmemcached-libs \
      # yaml \
      zlib \
      zstd-libs

RUN --mount=type=bind,from=upstream,source=/usr/local/bin,target=/opt/bin,rw \
    --mount=type=cache,target=/usr/local/lib/php/test \
    --mount=type=cache,target=/usr/local/lib/php/doc \
    --mount=type=bind,from=ghcr.io/php/pie:nightly-bin,source=/,target=/opt/bin2,rw \
      set -x \
      && export PATH=$PATH:/opt/bin:/opt/bin2 \
      && curl -fsSL -o /tmp/igbinary.tar.gz https://github.com/igbinary/igbinary/archive/master.tar.gz \
      && tar -zxvf /tmp/igbinary.tar.gz -C /tmp \
      && mkdir -p /usr/src/php/ext \
      && touch /usr/src/php/.docker-extracted \
      && mv /tmp/igbinary-master /usr/src/php/ext/igbinary \
      && docker-php-ext-configure igbinary \
      && docker-php-ext-install igbinary \
      && apk add --no-cache --virtual .pecl_build_deps $PECL_BUILD_DEPS $PHPIZE_DEPS \
      && apk add --no-cache --virtual .pecl_run_deps $PECL_RUN_DEPS \
      && export PIE_CONFIG="--with-php-config=/usr/local/bin/php-config \
                           --with-php-path=/usr/local/bin/php \
                           --with-phpize-path=/usr/local/bin/phpize \
                           --skip-enable-extension \
                           --force" \
      && pie -n install ${PIE_CONFIG} \
                     kjdev/zstd \
      # && pie -n install ${PIE_CONFIG} \
      #                igbinary/igbinary:dev-main \
      && pie -n install ${PIE_CONFIG} \
                     phpredis/phpredis \
                     --enable-redis-igbinary --enable-redis-zstd \
      && pie -n install ${PIE_CONFIG} \
                     php-memcached/php-memcached \
                     --enable-memcached-igbinary \
      && pie -n install ${PIE_CONFIG} \
                     xdebug/xdebug \
      && docker-php-ext-enable zstd \
      && echo "extension=redis" > $PHP_INI_DIR/conf.d/docker-php-ext-z-redis.ini \
      && echo "extension=memcached" > $PHP_INI_DIR/conf.d/docker-php-ext-z-memcached.ini \
      && strip --strip-all $(php-config --extension-dir)/redis.so \
      && strip --strip-all $(php-config --extension-dir)/memcached.so \
      && strip --strip-all $(php-config --extension-dir)/zstd.so \
      && strip --strip-all $(php-config --extension-dir)/xdebug.so \
      && apk del --no-network .pecl_build_deps \
      && rm -rf /tmp/* \
      && rm -rf /root/.pie \
      && rm -rf /root/.composer \
      && rm -rf /usr/src/php \
      && rm -rf /usr/local/lib/php/.registry/.channel.pecl.php.net/* \
      && php -m \
      && ls -la $(php-config --extension-dir) \
      && php -d error_reporting=22527 -d display_errors=1 -r 'var_dump(iconv("UTF-8", "UTF-8//IGNORE", "This is the Euro symbol '\''€'\''."));' \
# smoke test
      && php --version



WORKDIR /app

ENTRYPOINT ["docker-php-entrypoint"]

ARG VCS_REF="unknow"

LABEL org.opencontainers.image.revision=$VCS_REF \
      org.opencontainers.image.source="https://github.com/khs1994-docker/php"

ENV GODEBUG=cgocheck=0

ARG FRANKENPHP_VERSION='v1.9.0'

RUN --mount=type=bind,from=go,source=/usr/local/go,target=/usr/local/go,rw \
    --mount=type=cache,target=/root/go,rw \
    --mount=type=secret,id=github-token \
  set -x \
  && apk add --no-cache \
	# ca-certificates \
	libcap \
	mailcap \
  && apk add --no-cache --virtual .build-deps \
	$PHPIZE_DEPS \
	argon2-dev \
	# Needed for the custom Go build
	# bash \
	brotli-dev \
	coreutils \
	curl-dev \
	# Needed for the custom Go build
	git \
	gnu-libiconv-dev \
	libsodium-dev \
	# Needed for the file watcher \
	cmake \
	libstdc++ \
	libxml2-dev \
	linux-headers \
	oniguruma-dev \
	openssl-dev \
	readline-dev \
	sqlite-dev \
  pcre2-dev \
	upx \
  && git clone -b ${FRANKENPHP_VERSION} --depth=1 https://github.com/php/frankenphp /go/src/app \
  && cp /go/src/app/caddy/frankenphp/Caddyfile /etc/caddy/Caddyfile \
  && ln /etc/caddy/Caddyfile /etc/frankenphp/Caddyfile \
  && export FRANKENPHP_VERSION=${FRANKENPHP_VERSION} \
  && export NO_COMPRESS='' \
  && export PATH=/usr/local/go/bin:$PATH \
  && export GOTOOLCHAIN=local \
  && mkdir -p /usr/local/src/watcher \
  && cd /usr/local/src/watcher \
  && if [ -f /run/secrets/github-token ] && [ -s /run/secrets/github-token ]; then \
        curl -s -H "Authorization: Bearer $(cat /run/secrets/github-token)" https://api.github.com/repos/e-dant/watcher/releases/latest; \
    else \
        curl -s https://api.github.com/repos/e-dant/watcher/releases/latest; \
    fi | \
  grep tarball_url | \
  awk '{ print $2 }' | \
  sed 's/,$//' | \
  sed 's/"//g' | \
  xargs curl -L | \
  tar xz --strip-components 1 && \
  cmake -S . -B build -DCMAKE_BUILD_TYPE=Release && \
  cmake --build build && \
  cmake --install build \
  && cd /go/src/app \
  && go mod download \
  && cd /go/src/app/caddy \
  && go mod download \
  && cd /go/src/app \
  && export CGO_CFLAGS="-DFRANKENPHP_VERSION=$FRANKENPHP_VERSION $PHP_CFLAGS" \
  && export CGO_CPPFLAGS=$PHP_CPPFLAGS \
  && export CGO_LDFLAGS="-lssl -lcrypto -lreadline -largon2 -lcurl -lonig -lz $PHP_LDFLAGS" \
  && cd /go/src/app/caddy/frankenphp \
  && GOBIN=/usr/local/bin \
    ../../go.sh install -ldflags "-w -s -extldflags '-Wl,-z,stack-size=0x80000' -X 'github.com/caddyserver/caddy/v2.CustomVersion=FrankenPHP $FRANKENPHP_VERSION PHP $PHP_VERSION Caddy'" -buildvcs=true && \
	setcap cap_net_bind_service=+ep /usr/local/bin/frankenphp && \
	([ -z "${NO_COMPRESS}" ] && upx --best /usr/local/bin/frankenphp || true) && \
	frankenphp version && \
	frankenphp build-info \
  # copy watcher shared library (libgcc and libstdc++ are needed for the watcher)
  # && cp -a /usr/local/lib/libwatcher* /usr/local/lib/ \
  && apk add --no-cache libstdc++ && \
	ldconfig /usr/local/lib \
  # && cp -a /usr/local/bin/frankenphp /usr/local/bin/frankenphp \
  && rm -rf /go/src \
  && rm -rf /usr/local/src/watcher \
  && rm -rf /root/.cache \
  && rm -rf /root/.config \
  && apk del --no-network .build-deps \
  && setcap cap_net_bind_service=+ep /usr/local/bin/frankenphp && \
	frankenphp version && \
	frankenphp build-info

CMD ["--config", "/etc/frankenphp/Caddyfile", "--adapter", "caddyfile"]
HEALTHCHECK CMD curl -f http://localhost:2019/metrics || exit 1

# See https://caddyserver.com/docs/conventions#file-locations for details
ENV XDG_CONFIG_HOME=/config
ENV XDG_DATA_HOME=/data

EXPOSE 80
EXPOSE 443
EXPOSE 443/udp
EXPOSE 2019

# ARG FRANKENPHP_VERSION='dev'
# ARG NO_COMPRESS=''

# ENV PATH=/usr/local/go/bin:$PATH
# ENV GOTOOLCHAIN=local

# See https://github.com/docker-library/php/blob/master/8.3/alpine3.20/zts/Dockerfile#L53-L55
# ENV CGO_CFLAGS="-DFRANKENPHP_VERSION=$FRANKENPHP_VERSION $PHP_CFLAGS"
# ENV CGO_CPPFLAGS=$PHP_CPPFLAGS
# ENV CGO_LDFLAGS="-lssl -lcrypto -lreadline -largon2 -lcurl -lonig -lz $PHP_LDFLAGS"
